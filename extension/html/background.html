<script type="text/javascript">
// parseUri 1.2.2
// (c) Steven Levithan <stevenlevithan.com>
// MIT License
function parseUri(str) {
    var o = parseUri.options,
            m = o.parser[o.strictMode ? "strict" : "loose"].exec(str),
            uri = {},
            i = 14;

    while (i--) {
        uri[o.key[i]] = m[i] || "";
    }

    uri[o.q.name] = {};
    uri[o.key[12]].replace(o.q.parser, function ($0, $1, $2) {
        if ($1) {
            uri[o.q.name][$1] = $2;
        }
    });

    return uri;
}

parseUri.options = {
    strictMode: false,
    key: ["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],
    q:   {
        name:   "queryKey",
        parser: /(?:^|&)([^&=]*)=?([^&]*)/g
    },
    parser: {
        strict: /^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,
        loose:  /^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/
    }
};

function ApigeeConsoleUtils() {

    this.pagesOfInterest = ['dev.twitter.com', 'developers.facebook.com', 'help.simplegeo.com'];

    this.endpointmap = {};
    this.endpointmap["api.twitter.com"] = "twitter";
    this.endpointmap["graph.facebook.com"] = "facebook";

    this.urls = [];
    this.init = function () {
        this.loadWADL('truveo-wadl.xml', 'http://xml.truveo.com');
        this.loadWADL('facebook-wadl.xml', 'https://graph.facebook.com');
        this.loadWADL('simplegeo-wadl.xml', 'http://api.simplegeo.com/0.1');
        this.loadWADL('twitter-wadl.xml', 'http://api.twitter.com/1');
    };

    this.loadWADL = function (wadl, api) {
        var xhttp = new XMLHttpRequest(), exampleNodes;
        xhttp.open("GET", chrome.extension.getURL("wadl/" + wadl), false);
        xhttp.send();
        exampleNodes = xhttp.responseXML.getElementsByTagName('example');
        for (var count = 0; count < exampleNodes.length; count++) {
            this.urls.push(api + exampleNodes[count].attributes.url.nodeValue);
        }
    };

    // Function to fix the url, as of now it adds the default protocol ('http')
    // if the url doesn't have a protocol associated
    this.fixUrl = function (url) {
        if (url.indexOf('http') !== 0) {
            url = 'http://' + url;
        }
        return url;
    };

    // Returns the apigee console provider for the given url
    // twitter/facebook/others
    this.getApigeeConsoleEndpoint = function (url) {
        return this.endpointmap[url.host] !== null ? this.endpointmap[url.host] : 'others';
    };

    this.consoleLinkPrefix = "https://app.apigee.com/console/#apimet=";
    this.consoleLinkSuffix = encodeURIComponent("__apiidx__=null__apisecure__=true__apiprovider__=others");
    // Returns the apigee console url with all the parameters set
    this.buildApigeeConsoleUrl = function (url) {
        url = parseUri(this.fixUrl(url));
        var consoleUrl = this.consoleLinkPrefix.replace('console/', 'console/' + this.getApigeeConsoleEndpoint(url)) +
                encodeURIComponent(url.source) +
                this.consoleLinkSuffix.replace('others', this.getApigeeConsoleEndpoint(url));
        return consoleUrl;
    };

    this.navigate = function (url) {
        chrome.tabs.getSelected(null, function (tab) {
            chrome.tabs.update(tab.id, {url: url});
        });
    };
}

var ApigeeConsole = new ApigeeConsoleUtils();
ApigeeConsole.init();

// This event is fired with the user accepts the input in the omnibox.
chrome.experimental.omnibox.onInputEntered.addListener(
        function (text) {
            try {
                ApigeeConsole.navigate(ApigeeConsole.buildApigeeConsoleUrl(text));
            } catch (err) {
                alert('Please enter a valid url');
            }
        });

chrome.experimental.omnibox.onInputChanged.addListener(
        function (text, suggest) {
            if (text === '') {
                return;
            }

            var res = [];
            for (var i in ApigeeConsole.urls) {
                if (ApigeeConsole.urls[i].search(text) > 0) {
                    res.push({
                            content: ApigeeConsole.urls[i],
                            description: ApigeeConsole.urls[i],
                            descriptionStyles: [chrome.experimental.omnibox.styleNone(1)]
                        });
                }
            }
            suggest(res);
        }
        );

// Listen for any changes to the URL of any tab.
chrome.contextMenus.create({"title": "Test with apigee", "contexts":["link","selection"],
    "onclick": function (info, tab) {
        try {
            ApigeeConsole.navigate(ApigeeConsole.buildApigeeConsoleUrl(info.linkUrl));
        } catch (err) {
            alert('Please enter a valid url');
        }
    }});

chrome.tabs.onUpdated.addListener(function (tabId, changeInfo, tab) {
    for (var i in ApigeeConsole.pagesOfInterest) {
        if (tab.url.indexOf(ApigeeConsole.pagesOfInterest[i]) > 0) {
          // ... show the page action.
          chrome.pageAction.show(tabId);
          break;
        }
    }
});
</script>
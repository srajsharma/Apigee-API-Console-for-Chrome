<script type="text/javascript">
    var ApigeeConsole = new ApigeeConsoleUtils;
    function ApigeeConsoleUtils() {
        this.endpointmap = {};
        this.endpointmap["api.twitter.com"] = "twitter";
        this.endpointmap["graph.facebook.com"] = "facebook";

        // Function to fix the url, as of now it adds the default protocol ('http')
        // if the url doesn't have a protocol associated
        this.fixUrl = function(url) {
            if (url.indexOf('http') != 0) {
                url = 'http://' + url;
            }
            return url;
        };

        // Returns the apigee console provider for the given url
        // twitter/facebook/others
        this.getApigeeConsoleEndpoint = function(url) {
            return this.endpointmap[url["host"]] != null ? this.endpointmap[url["host"]] : 'others';
        };

        this.consoleLinkPrefix = "https://app.apigee.com/console/#apimet=";
        this.consoleLinkSuffix = encodeURIComponent("__apiidx__=null__apisecure__=true__apiprovider__=others");
        // Returns the apigee console url with all the parameters set
        this.buildApigeeConsoleUrl = function(url) {
            url = parseUri(this.fixUrl(url));
            var consoleUrl = this.consoleLinkPrefix.replace('console/', 'console/' + this.getApigeeConsoleEndpoint(url)) +
                    encodeURIComponent(url["source"]) +
                    this.consoleLinkSuffix.replace('others', this.getApigeeConsoleEndpoint(url));
            return consoleUrl;
        };
    }

    function navigate(url) {
        chrome.tabs.getSelected(null, function(tab) {
            chrome.tabs.update(tab.id, {url: url});
        });
    };

    // This event is fired with the user accepts the input in the omnibox.
    chrome.experimental.omnibox.onInputEntered.addListener(
            function(text) {
                try {
                    navigate(ApigeeConsole.buildApigeeConsoleUrl(text));
                } catch (err) {
                    alert('Please enter a valid url');
                }
            });
    
    // parseUri 1.2.2
    // (c) Steven Levithan <stevenlevithan.com>
    // MIT License
    function parseUri(str) {
        var o = parseUri.options,
                m = o.parser[o.strictMode ? "strict" : "loose"].exec(str),
                uri = {},
                i = 14;

        while (i--) uri[o.key[i]] = m[i] || "";

        uri[o.q.name] = {};
        uri[o.key[12]].replace(o.q.parser, function ($0, $1, $2) {
            if ($1) uri[o.q.name][$1] = $2;
        });

        return uri;
    };

    parseUri.options = {
        strictMode: false,
        key: ["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],
        q:   {
            name:   "queryKey",
            parser: /(?:^|&)([^&=]*)=?([^&]*)/g
        },
        parser: {
            strict: /^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,
            loose:  /^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/
        }
    };
</script>